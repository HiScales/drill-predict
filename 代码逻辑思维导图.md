# 布孔预测代码逻辑思维导图

## 🎯 系统目标
智能预测工程地质勘察中的钻孔位置

## 📊 数据输入
```
Excel文件结构：
├── Site (场地边界坐标)
├── Building (建筑物坐标，可选)
├── Drill (真实钻孔位置，用于验证)
└── Spacing (间距约束 [最小, 最大])
```

## 🔄 核心算法流程

### 1️⃣ 数据预处理
```
读取Excel → 生成多边形 → 提取特征点
├── 场地多边形 (site_poly)
├── 建筑物多边形组 (buildings)
└── 间距约束 (min_spacing, max_spacing)
```

### 2️⃣ 场地方向分析
```
calculate_site_orientation()
├── 提取边界边
├── 计算每条边的角度和长度
├── 按边长加权排序
└── 返回主方向角度
```

### 3️⃣ 智能网格生成
```
generate_rotated_grid()
├── 计算场地边界和中心点
├── 生成基础正交网格
├── 应用旋转变换
├── 过滤场地内的点
└── 动态添加中点优化密度
```

### 4️⃣ 智能布孔选择
```
select_uniform_grid_points_with_priority()
├── 第一步：收集建筑物特征点
│   ├── 建筑物角点 (building_corners)
│   └── 建筑物边中点 (building_midpoints)
├── 第二步：智能选择建筑物特征点
│   ├── 优先选择所有角点
│   └── 智能选择合规边中点
├── 第三步：生成均匀网格
│   ├── 计算场地方向
│   └── 生成旋转网格候选点
├── 第四步：过滤和排序
│   ├── 剔除靠近建筑物的点
│   └── 按距离排序，优先稀疏区域
└── 第五步：依次添加网格点
    └── 保证间距约束
```

## 🎨 可视化层次
```
plot_drills()
├── 场地边界 (黑色粗线)
├── 建筑物 (蓝色线条)
├── 网格线 (灰色线条)
├── 网格候选点 (浅蓝色小点)
├── 真实钻孔点 (绿色圆圈)
└── 预测钻孔点 (红色叉号)
```

## 📈 优先级策略

### 🥇 第一优先级：建筑物角点
- 所有建筑物角点无条件选择
- 代表结构关键位置

### 🥈 第二优先级：合规边中点
- 检查与角点的距离
- 跳过违反最小间距的点

### 🥉 第三优先级：网格补充点
- 均匀网格分布
- 优先补充稀疏区域

## 🔧 关键技术

### 几何算法
- **Shapely**: 多边形操作和空间关系
- **旋转变换**: 自适应网格方向
- **距离计算**: 欧几里得距离约束

### 优化策略
- **动态密度**: 稀疏区域自动添加中点
- **边界过滤**: 只保留场地内的点
- **间距验证**: 严格约束检查

### 可视化技术
- **Matplotlib**: 多层次绘图
- **颜色编码**: 不同类型点用不同颜色
- **透明度控制**: 避免视觉干扰

## 📊 输出结果

### 文件输出
- `{project_id}_pred.xlsx`: 预测钻孔位置
- `{project_id}_compare.png`: 对比可视化图

### 统计信息
- 项目基本信息 (面积、边界长度、建筑物数量)
- 布孔统计 (角点数、边中点数、网格补充点数)
- 间距分析 (最小/最大/平均间距，违规情况)
- 精度评估 (与真实钻孔的对比分析)

## 🚀 算法优势

### 技术特点
1. **几何优先**: 符合工程实际需求
2. **自适应网格**: 根据场地形状调整
3. **严格约束**: 确保间距要求
4. **智能密度**: 动态优化分布
5. **可视化清晰**: 便于理解和验证

### 适用场景
- 工程地质勘察钻孔规划
- 建筑物周边布孔
- 大面积场地均匀布点
- 复杂边界自适应处理

### 性能特点
- **高效算法**: O(n²)复杂度
- **内存友好**: 逐步处理
- **鲁棒性强**: 完善异常处理
- **可扩展性**: 模块化设计

## 🔍 核心函数关系

```
main()
├── read_project_xlsx() → 数据读取
├── get_polygons() → 几何处理
├── calculate_site_orientation() → 方向分析
├── generate_rotated_grid() → 网格生成
├── select_uniform_grid_points_with_priority() → 智能布孔
├── plot_drills() → 可视化
└── save_pred_to_excel() → 结果保存
```

这个系统通过智能的几何算法和优先级策略，能够自动生成符合工程要求的钻孔位置，大大提高了布孔规划的效率和准确性。 